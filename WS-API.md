# WebSocket API - Specification
----
1. [Формат Events](WS-API.md#%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82-events)
2. [Формат Payload](WS-API.md#%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82-payload)
3. [Формат передаваемых данных](WS-API.md#%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D0%B2%D0%B0%D0%B5%D0%BC%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-data)
----
## Формат Events
Все взаимодействия между /back и /front, в дальнейшем именуемые events, имеют следующий формат
```json
{
"id": 1234123412341,
"format_id": 1,
"payload": {...}
}
```
### Аттрибуты
* **id** - Уникальный в пределах системы числовой идентификатор события. Инкрементируется при появлении каждого нового сообщения.
* **format_id** - Идентификатор формата данных в payload
* **payload** - Передаваемый объект

> Сообщения от сервера к клиенту пересылаться массивами
>```json
>[{
>  "id": 1234,
>  "format_id": 1,
>  "payload": {...}
>  },
>  {
>  "id": 1234,
>  "format_id": 1,
>  "payload": {...}
>  }, 
>  ...
>]
>```

> А от клиента к серверу - объектами. 
>```json
>{
>  "format_id": 1,
>  "payload": {...}
>}
>```

> В случае когда формирование сообщения происходит на клиенте - поле "id" может отсутствовать, в любом случае его значение не учитывается.

При отсылке клиентом сообщения, в ответе приходит код выполнения и уникальный идентификатор сообщения если отсылка выполнена успешно.
```json
{
"error": {
   "code": 1,
   "text": "Текст ошибки",
   },
"id": 0,
}
```
### Аттрибуты
* **id** - Уникальный в пределах системы числовой идентификатор события. Инкрементируется при появлении каждого нового сообщения.
* **error** - Результат операции
  * **code** - Код ошибки или 0
  * **text** - Текст ошибки либо "" при code=0

| Код ошибки |   Описание  |
|:----------:|:-----------:|
| `0` | Сообщение отправлено успешно |
| `1` | Произошла низвестная проблема |

> В случае code=0 - гарантирует что сообщение принято сервером в обработку.

> В дальнейшем, сообщения о доставке, прочтении и т.п. приходят в связке с переданным идентификатором сообщения **id**

## Формат Payload
| format_id | Описание |
|:---------:|:--------:|
|    `1`    | Пользовательские сообщения |
|    `2`    | Статусы пользовательских сообщений |
|    `3`    | Информационные сообщения |

### `1` Пользовательские сообщения
```json
{
"time": 24545455252,
"type_id": 3,
"sender_id": 1876876,
"chat_id": 123,
"is_forward": true,
"data": {...}
}
```
#### Аттрибуты
* **time** - время создания сообщения в Unix Timestamp
* **type_id** - Идентификатор типа данных
* **sender_id** - Уникальный идентификатор отправителя
* **chat_id** - Уникальный идентификатор чата
* **is_forward** - флаг определяющий что данные являются переслаными.
* **data** - Полезные данные

> В случае когда **is_forward** = **true** поле **data** содержит **event** пересылаемого сообщения

|     type_id    |   Описание  |
|:--------------:|:-----------:|
| `1` | Карточка "Новость" |
| `2` | Карточка "Статья" |
| `3` | Карточка "[Рекламный блок](WS-API.md#3-%D0%A0%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D1%8B%D0%B9-%D0%B1%D0%BB%D0%BE%D0%BA)" |
| `4` | Карточка "Викторина" |
| `5` | Карточка "Партнерский контент" |
| `6` | Карточка "Место" |
| `7` | Карточка "Мероприятие" |
| `8` | Карточка "Матч" |
| `9` | Карточка "Розыгрыш" |
| `10` | Карточка "Купоны и скидки" |
|      |  |
| `101` | [Текстовое сообщение](WS-API.md#101-%D0%A2%D0%B5%D0%BA%D1%81%D1%82%D0%BE%D0%B2%D0%BE%D0%B5-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5) |
| `102` | [Картинка](WS-API.md#102-%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B0) |
| `103` | [HTML](WS-API.md#103-html) |
| `104` | Координаты |
| `105` | [Видео](WS-API.md#105-%D0%92%D0%B8%D0%B4%D0%B5%D0%BE) |
| `106` | Стикер |
| `107` | Контакты профиля |

### `2` Статусы пользовательских сообщения
```json
{
"time": 24545455252,
"type_id": 3,
"sender_id": 1876876,
"chat_id": 123,
"data": {...}
}
```
#### Аттрибуты
* **time** - время создания сообщения в Unix Timestamp
* **type_id** - Идентификатор типа данных
* **sender_id** - Уникальный идентификатор отправителя
* **chat_id** - Уникальный идентификатор чата
* **data** - Полезные данные

|     type_id    |   Описание  |
|:--------------:|:-----------:|
| `201` | [Сообщение доставлено](WS-API.md#201-%D0%A1%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%BE) |
| `202` | [Сообщение прочитано](WS-API.md#202-%D0%A1%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D1%87%D0%B8%D1%82%D0%B0%D0%BD%D0%BE) |

### `3` Информационные сообщения
```json
{
"time": 24545455252,
"type_id": 205,
"data": {...}
}
```
#### Аттрибуты
* **time** - время создания сообщения в Unix Timestamp
* **type_id** - Идентификатор типа данных
* **data** - Полезные данные

|     type_id    |   Описание  |
|:--------------:|:-----------:|
| `203` | [Данные о пользователе](WS-API.md#203-%D0%94%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D0%BE-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5) |
| `204` | [Запрос на добавление в друзья](WS-API.md#204-%D0%97%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2-%D0%B4%D1%80%D1%83%D0%B7%D1%8C%D1%8F) |
| `205` | [Лайк профайла пользователя](WS-API.md#205-%D0%9B%D0%B0%D0%B9%D0%BA-%D0%BF%D1%80%D0%BE%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F) |

## Формат передаваемых данных (data)
### `3` Рекламный блок
#### Сервер => Клиент
```json
{
  "id": 25060,
  "photo_url": "http://cdn.fanlive2018.ru/445445/4534/photo.jpg",
  "text": "МакЭксперс, кофе с собой, опбалат картой, круглосуточная жрачка..."
}
```
##### Аттрибуты
* **id** - Идентификатор карточки рекламного блока
* **photo_url** - URL рекламного баннера
* **text** - Текст рекламного баннера

#### Клиент => Сервер
```json
{
  "id": 25060,
}
```
##### Аттрибуты
* **id** - Идентификатор карточки рекламного блока

### `101` Текстовое сообщение
```json
{
  "message": "Здравствуй Петя!",
}
```
##### Аттрибуты
* **message** - Текстовое сообщение

> В случае когда **is_forward** = **true** поле **data** содержит **event** пересылаемого сообщения
>```json
>{
>"time": 24545455252,
>"type_id": 101,
>"sender_id": 1876876,
>"chat_id": 123,
>"is_forward": true,
>"data": {
>  "id": 1234123412341,
>  "format_id": 1,
>  "payload": {
>     "time": 44545455252,
>     "type_id": 101,
>     "sender_id": 11876876,
>     "chat_id": 123,
>     "is_forward": false,
>     "data": {
>        "message": "Здравствуй Петя!",
>        }
>     }
>  }
>}
>```

### `102` Картинка
```json
{
"image": "https://cdn.fanlive2018.ru/445445/4534/photo3.jpg",
"text": "текстовые данные",
}
```
#### Аттрибуты
* **image** - URL картинки
* **text** - Текстовая подпись для картинки
> В случае когда **is_forward** = **true** поле **data** содержит **event** пересылаемого сообщения

### `103` HTML
```json
{
  "html": " <!DOCTYPE html><html><body><h1>My First Heading</h1><p>My first paragraph.</p></body></html> ",
}
```
#### Аттрибуты
* **html** - HTML 
> В случае когда **is_forward** = **true** поле **data** содержит **event** пересылаемого сообщения

### `105` Видео
```json
{
"video": "https://cdn.fanlive2018.ru/445445/4534/video.mp4",
"text": "текстовые данные",
}
```
#### Аттрибуты
* **video** - URL видео
* **text** - Текстовая подпись для картинки

### `201` Сообщение доставлено
```json
{
"id": 123132,
}
```
#### Аттрибуты
* **id** - Уникальный идентификатор сообщения
> Присылается в случае когда сообщение доставлено хотя-бы одному получателю

### `202` Сообщение прочитано
```json
{
"id": 123132,
}
```
#### Аттрибуты
* **id** - Уникальный идентификатор сообщения
> Присылается в случае когда сообщение прочитано хотя-бы одним получателем

### `203` Данные о пользователе
```json
{
"id": 123132,
"name": "Светлана",
"avatar_url": "http://blablabla.ru/blabla.png",
"logo_url": "http://blablabla.ru/command.png",
"status_friend_id": 0
}
```
#### Аттрибуты
* **id** - Уникальный идентификатор пользователя
* **name** - Имя пользователя
* **avatar_url** - URL аватара
* **logo_url** - URL логотипа
* **status_friend_id** - Идентификатор статуса дружбы
> Присылается в случае когда изменены пользовательские данные

| status_friend_id |   Описание  |
|:----------:|:-----------:|
| `0` | Отсутствует (не друзья и никогда не были) |
| `1` | Этот id удалил нас из друзей |
| `2` | Этот id нам отправил запрос в друзья |
| `3` | Отправлен запрос в друзья этому id |
| `4` | Мы друзья с этим id |
| `5` | Этот id отклонил наш запрос в друзья |
| `6` | Мы разорвали дружбу с этим id |

### `204` Запрос на добавление в друзья
```json
{
"sender_id": 123132,
"recv_id": 3245234,
}
```
#### Аттрибуты
* **sender_id** - Уникальный идентификатор пользователя отправившего запрос
* **recv_id** - Уникальный идентификатор пользователя получателя запроса

### `205` Лайк профайла пользователя

```json
{
"sender_id": 123132,
"ops": 1,
}
```
#### Аттрибуты
* **sender_id** - Уникальный идентификатор пользователя
* **ops** - 1 - Лайк, 0 - Дизлайк
> Данный тип сообщения может передаваться только с сервера

